# Missing values

```{r include=FALSE}
knitr::opts_chunk$set(echo= TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(patchwork)
library(ggnewscale)
library(rtweet)
library(sjmisc)
library(readr)
```

This is our code of missing value plots.
```{r}
plot_missing <- function(data, percent) {
    colnames(data) <-  abbreviate(colnames(data), minlength = 3)
    mp <- data.frame(is.na(data)) %>%
      group_by_all() %>%
      count(name = "count", sort = TRUE) %>%
      ungroup()
    
    missing_patterns <- mp %>% select(c(1:ncol(mp)-1))
    
    sorted_num_missing <- sort(colSums(is.na(data)), decreasing = TRUE, index.return=TRUE)
    level <-  colnames(missing_patterns[sorted_num_missing$ix])
    mid <- level[ceiling(length(level)/2)] # get name of var located at the center of graph to put "complete case"

    tidy_missing_patterns <- 
      missing_patterns %>%
      add_column(complete = if_else(rowSums(missing_patterns)==0, TRUE, FALSE)) %>%
      rownames_to_column("id") %>%
      gather(key, value, c(-id,-complete))
    
    df <- sorted_num_missing$x
    
    top_count <- data.frame(
      name=names(df) ,  
      value=df)
    
    top_percent <- data.frame(
      name=names(df) ,  
      value=df*100/nrow(data))
    
    cmp <- missing_patterns %>%
      add_column(complete = if_else(rowSums(missing_patterns)==0, TRUE, FALSE))
    
    side_count <- data.frame(
      name=as.factor(seq.int(1:nrow(missing_patterns))),
      value=mp$count,
      complete=cmp$complete
    )
    
    side_percent <- data.frame(
      name=as.factor(seq.int(1:nrow(missing_patterns))),
      value=mp$count*100/nrow(data),
      complete=cmp$complete
    )
    
    if (percent) {
      p1 <- ggplot(top_percent, aes(x=fct_relevel(name, level), y=value)) + 
        geom_bar(stat = "identity", alpha=0.8, fill="#97b7f3") +
        ylim(0, 100) + 
        ylab("% rows missing:") + 
        theme(axis.title.x=element_blank()) +
        ggtitle("Missing value patterns")

      p2 <-ggplot(side_percent, aes(x=fct_rev(name), y=value, fill=complete)) + 
        geom_bar(stat = "identity", alpha=0.8) +
        scale_fill_manual(values =  c("#97b7f3", "#6396ec")) + 
        coord_flip() +
        ylab("% row") +
        ylim(0, 100) + 
        theme(axis.title.y=element_blank()) + 
        theme(legend.position = "none")
      
    } else {
      p1 <- ggplot(top_count, aes(x=fct_relevel(name, level), y=value)) + 
        geom_bar(stat = "identity", alpha=0.8, fill="#97b7f3") +
        ylab("num rows missing:") + 
        theme(axis.title.x=element_blank()) +
        ggtitle("Missing value patterns")
      
      p2 <- ggplot(side_count, aes(x=fct_rev(name), y=value, fill=complete)) + 
        geom_bar(stat = "identity", alpha=0.8) +
        scale_fill_manual(values =  c("#97b7f3", "#6396ec")) + 
        coord_flip() +
        ylab("row count") + 
        theme(axis.title.y=element_blank()) +
        theme(legend.position = "none")
    }
    

    tidy_missing_patterns$id <- as.factor(as.integer(tidy_missing_patterns$id))
    p3 <-ggplot(tidy_missing_patterns, aes(x = fct_relevel(key, level), y = fct_rev(id), fill = value)) +
      geom_tile(color = "white", aes(alpha=complete)) +
      geom_text(aes(label = ifelse(complete == TRUE & key==mid, "complete cases", ""))) + 
      scale_fill_manual(values =  c("#b3b3b3", "#9370da")) + 
      scale_alpha_manual(values =  c(0.7, 1.0)) + 
      xlab("variable") + 
      ylab("missing pattern") +
      theme_bw() + 
      theme(legend.position = "none")
    p1 + plot_spacer() + p3 + p2 + plot_layout(widths = c(3,1), heights = unit(c(2,1), c('cm','null')))
}
```

```{r}
names <- c('BarackObama', 'justinbieber', 'ArianaGrande', 'ladygaga', 'YouTube', 'KimKardashian', 'elonmusk', 'Twitter', 'BillGates', 'CNN', 'ddlovato', 'nytimes', 'NASA', 'BBCBreaking', 'KylieJenner', 'wizkhalifa', 'LilTunechi', 'NBA', 'POTUS', 'Pink', 'JoeBiden', 'NFL', 'AmitShah', 'WhiteHouse', 'danieltosh', 'AnushkaSharma', 'davidguetta', 'SnoopDogg', 'WSJ', 'KamalaHarris', 'SpaceX', 'VancityReynolds', 'Forbes', 'ABC', 'RobertDowneyJr', 'FLOTUS', 'TheRock', 'AP', 'RyanSeacrest', 'UN', 'BigSean', 'johnlegend', 'netflix', 'FortniteGame', 'JohnCena', 'cnni', 'AOC', 'Marvel', 'enews')

tag <- c('corona', '#corona', 'coronavirus', '#coronavirus', 'covid', '#covid', 'covid19', '#covid19', 'covid-19', '#covid-19', 'sarscov2', '#sarscov2', 'sars cov2', 'sars cov 2', 'covid_19', '#covid_19', '#ncov', 'ncov', '#ncov2019', 'ncov2019', '2019-ncov', '#2019-ncov', 'pandemic', '#pandemic #2019ncov', '2019ncov', 'quarantine', '#quarantine', 'flatten the curve', 'flattening the curve', '#flatteningthecurve', '#flattenthecurve', 'hand sanitizer', '#handsanitizer', '#lockdown', 'lockdown', 'social distancing', '#socialdistancing', 'work from home', '#workfromhome', 'working from home', '#workingfromhome', 'ppe', 'n95', '#ppe', '#n95', '#covidiots', 'covidiots', 'herd immunity', '#herdimmunity', 'pneumonia', '#pneumonia', 'chinese virus', '#chinesevirus', 'wuhan virus', '#wuhanvirus', 'kung flu', '#kungflu', 'wearamask', '#wearamask', 'wear a mask', 'vaccine', 'vaccines', '#vaccine', '#vaccines', 'corona vaccine', 'corona vaccines', '#coronavaccine', '#coronavaccines', 'face shield', '#faceshield', 'face shields', '#faceshields', 'health worker', '#healthworker', 'health workers', '#healthworkers', '#stayhomestaysafe', '#coronaupdate', '#frontlineheroes', '#coronawarriors', '#homeschool', '#homeschooling', '#hometasking', '#masks4all', '#wfh', 'wash ur hands', 'wash your hands', '#washurhands', '#washyourhands', '#stayathome', '#stayhome', '#selfisolating', 'self isolating')
```

We collected 200 most recent tweets from top 50 users and chose the tweets that have at least one of the tags in them.
```{r eval=FALSE}
write_df <- data.frame()
for (name in names){
  new <- get_timelines(name, n=200)
  write_df <- rbind(new, write_df)
}
write_csv(write_df, "./resources/data.csv")
```

Get the tweet data from the csv file
```{r}
df <- read_csv('./resources/data.csv')
```

We define the function that cleans the tweet data

Reference: https://stackoverflow.com/questions/31348453/how-do-i-clean-twitter-data-in-r
```{r}
clean_tweets <- function(x) {
  x %>%
    # Remove URLs
    str_remove_all(" ?(f|ht)(tp)(s?)(://)(.*)[.|/](.*)") %>%
    # Remove mentions e.g. "@my_account"
    str_remove_all("@[[:alnum:]_]{4,}") %>%
    # Replace "&" character reference with "and"
    str_replace_all("&amp;", "and") %>%
    # Remove punctuation, using a standard character class
    str_remove_all("[[:punct:]]") %>%
    # Remove "RT: " from beginning of retweets
    str_remove_all("^RT:? ") %>%
    # Replace any newline characters with a space
    str_replace_all("\\\n", " ") %>%
    # Make everything lowercase
    str_to_lower() %>%
    # Remove any trailing whitespace around the text
    str_trim("both") %>% 
    # remove unnecessary space
    str_replace_all("  "," ")
}
```

Clean the tweet data and extract the tweets that contains COVID related tags
```{r}
output <- c()
cleaned_text <- clean_tweets(df$text)
for (words in str_split(cleaned_text, " ")) {
  f <- if_else(any(words %in% tag), 1, 0)
  output <- append(output, f)
}

df$output <- output

df %>% filter(output == 1) -> df2
```

After filtering, there are total of 403 rows (tweets)
```{r}
nrow(df2)
```

Then we checked how many missing values each column has.
```{r}
df2 %>% summarise_all(funs(sum(is.na(.))))
```

```{r, fig.width=10, fig.height=10}
plot_missing(df2, percent = TRUE)
plot_missing(df2, percent = FALSE)
```

It is hard to draw any significant conclusion from columns that have more than 95% of entries with missing values.
Thus, we decided to remove all columns that have NA in more than 95% of entries.
```{r}
df3 <- df2 %>% select(which(colMeans(is.na(.)) <= 0.95))

df3
```

```{r}
df3 %>% summarise_all(funs(sum(is.na(.))))
```

```{r, fig.width=10, fig.height=10}
plot_missing(df3, percent = TRUE)
plot_missing(df3, percent = FALSE)
```

We can observe that columns [retweet_status_id, retweet_text, retweet_created_at, retweet_source, retweet_favorite_count, retweet_retweet_count, retweet_user_id, retweet_screen_name, retweet_name, retweet_followers_count, retweet_friends_count, retweet_statuses_count, retweet_verified] all have 365 missing values, meaning they all have correlations to each other. They have equal number of missing values and there are 365 out of 405 tweets that have those column values missing, so we can assume that most twitter users don't retweet the tweets regarding COVID. 
Also, columns [reply_to_user_id, reply_to_screen_name] have 384 values missing. These two columns are correlated to each other. Having 384 out of 405 entries missing indicates that most of the tweets regarding COVID are original posts, not replies to other posts. 
Column location has 78 missing values, which is approximately 25% of the 405 total entries. It seems that majority of the tweets regarding COVID have locations indicated, but it is at users' discretion. Moreover, column profile_background_url has 48 missing values, which is approximately 12% of 405. The low proportion of missing values indicates that most users have profile background url posted, but it is also up to users' choice.

There are still many columns that are not very significant for our final project's purpose, even some columns that have no missing values. Thus, we trimmed down the number of columns further.
Columns such as [source, display_text_width, reply_to_user_id, reply_to_screen_name, is_quote, is_retweet, retweet_status_id, retweet_text, retweet_created_at, retweet_source, retweet_favorite_count, retweet_retweet_count, retweet_user_id, retweet_screen_name, retweet_name, retweet_followers_count, retweet_friends_count, retweet_statuses_count, retweet_location, retweet_description, retweet_verified, status_url, url, protected, profile_url, profile_expanded_url, profile_banner_url, profile_background_url, profile_image_url, output] are all irrelevant or very insignificant in telling user's activity and tweets regarding COVID, which is what we are mainly concerned with. Thus, we removed all those columns for the sake of simplicity and cleanliness.

```{r}
cols_to_remove <- c('source', 'display_text_width', 'reply_to_user_id', 'reply_to_screen_name', 'is_quote', 'is_retweet', 'retweet_status_id', 'retweet_text', 'retweet_created_at', 'retweet_source', 'retweet_favorite_count', 'retweet_retweet_count', 'retweet_user_id', 'retweet_screen_name', 'retweet_name', 'retweet_followers_count', 'retweet_friends_count', 'retweet_statuses_count', 'retweet_location', 'retweet_description', 'retweet_verified', 'status_url', 'url', 'protected', 'profile_url', 'profile_expanded_url', 'profile_banner_url', 'profile_background_url', 'profile_image_url', 'output')

df4 <- select(df3, -cols_to_remove)

df4
```

```{r, fig.width=10, fig.height=10}
plot_missing(df4, percent = TRUE)
plot_missing(df4, percent = FALSE)
```

We can see that out of 18 columns, only 'location' column has some missing values remaining. We would have to impute the missing values or make a separate column for missing value indicator if we deem this column to be important for our future analysis. We used 200 tweets of top 50 users for creating this dataset, so the size of the dataset is small compared to what we will have for the final version of our project. When we use more tweets on more users, we may potentially have some more important observations.


